<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸²ã‚«ãƒ„ç”°ä¸­ æ³¨æ–‡ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-btn.active {
            border-color: #ff6b6b;
            color: #ff6b6b;
            font-weight: 600;
        }
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Simple animation for elements appearing */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto max-w-4xl p-2 sm:p-4 min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-md p-4 mb-4">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-center text-red-500">ğŸ» ä¸²ã‚«ãƒ„ç”°ä¸­ æ³¨æ–‡ç®¡ç† ğŸ»</h1>
            <p class="text-center text-gray-500 text-sm sm:text-base mt-1">ã‚°ãƒ«ãƒ¼ãƒ—ã§ã®æ³¨æ–‡ã‚’ã‚¹ãƒãƒ¼ãƒˆã«ç®¡ç†ï¼</p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-around bg-white rounded-xl shadow-md p-1 sm:p-2 mb-4 text-sm sm:text-base">
            <button class="tab-btn flex-1 py-2 px-1 sm:px-4 text-center text-gray-600 border-b-4 border-transparent transition" onclick="showTab('names')">å‚åŠ è€…ç™»éŒ²</button>
            <button class="tab-btn flex-1 py-2 px-1 sm:px-4 text-center text-gray-600 border-b-4 border-transparent transition" onclick="showTab('order')">æ³¨æ–‡</button>
            <button class="tab-btn flex-1 py-2 px-1 sm:px-4 text-center text-gray-600 border-b-4 border-transparent transition" onclick="showTab('history')">å±¥æ­´ãƒ»é›†è¨ˆ</button>
            <button class="tab-btn flex-1 py-2 px-1 sm:px-4 text-center text-gray-600 border-b-4 border-transparent transition" onclick="showTab('reset')">ãƒªã‚»ãƒƒãƒˆ</button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow bg-white rounded-xl shadow-md p-3 sm:p-4 md:p-6">
            <!-- Tab Content will be injected here by JavaScript -->
        </main>

    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert for Info/Error -->
    <div id="custom-alert" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-transform transform translate-x-full z-50">
        <p id="alert-message"></p>
    </div>


    <script>
        // --- DATA & STATE MANAGEMENT ---

        const state = {
            currentTab: 'names',
            registeredNames: [],
            currentOrders: [],
            orderHistory: [],
            selectedPerson: null,
        };

        const menu = {
            "ç››ã‚Šåˆã‚ã›": [
                { name: "å®šç•ª5æœ¬ç››ã‚Š", price: 800 },
                { name: "å®šç•ª8æœ¬ç››ã‚Š", price: 1370 },
                { name: "éŠ€ãƒã‚¤ãƒœãƒ¼ãƒ«", price: 460 },
            ],
            "è‚‰ä¸²": [
                { name: "ä¸²ã‚«ãƒ„ç‰›", price: 170 },
                { name: "ä¸²ã‚«ãƒ„è±š", price: 170 },
                { name: "ãƒãƒ ã‚«ãƒ„", price: 160 },
                { name: "è±šãƒ’ãƒ¬", price: 180 },
                { name: "ã‚¿ã‚¦ãƒªãƒ³ã‚¦ã‚£ãƒ³ãƒŠãƒ¼", price: 170 },
                { name: "é¶ã‚€ã­", price: 140 },
                { name: "é¶ã¤ãã­", price: 160 },
                { name: "ãƒ©ãƒ ", price: 230 },
                { name: "ã•ã•ã¿æ¢…å¤§è‘‰", price: 200 },
                { name: "ã•ã•ã¿ã¿ã‚‡ã†ãŒ", price: 200 },
                { name: "è±šã—ã", price: 200 },
            ],
            "æµ·é®®ä¸²": [
                { name: "ä¸Šã‚¨ãƒ“", price: 300 },
                { name: "ã¤ã¶è²", price: 250 },
                { name: "ã‚¢ã‚¸ãƒ•ãƒ©ã‚¤", price: 160 },
                { name: "ã‚­ã‚¹", price: 230 },
                { name: "ãŸã‚‰ã“", price: 140 },
                { name: "ã‚¨ãƒ“", price: 230 },
            ],
            "é‡èœä¸²": [
                { name: "ãƒ¬ãƒ³ã‚³ãƒ³", price: 190 },
                { name: "ç´…ã—ã‚‡ã†ãŒ", price: 160 },
                { name: "ãªã™ã³", price: 140 },
                { name: "ç‰ãƒã‚®", price: 100 },
                { name: "ã˜ã‚ƒãŒèŠ‹", price: 130 },
                { name: "ã«ã‚“ã«ã", price: 130 },
                { name: "ãƒˆãƒãƒˆ", price: 160 },
                { name: "ã—ã„ãŸã‘", price: 160 },
                { name: "å±±èŠ‹", price: 160 },
                { name: "ã‚¢ã‚¹ãƒ‘ãƒ©", price: 250 },
            ],
            "ãƒŸãƒƒã‚¯ã‚¹ä¸²": [
                { name: "ã‚¢ã‚¹ãƒ‘ãƒ©è±šå·»ã", price: 310 },
            ],
            "ä»–ä¸²": [
                { name: "ã†ãšã‚‰", price: 160 },
                { name: "ãƒãƒ¼ã‚º", price: 230 },
                { name: "ã‚‚ã¡", price: 180 },
                { name: "ã‚¯ãƒƒã‚­ãƒ¼ï¼†ã‚¯ãƒªãƒ¼ãƒ ", price: 180 },
                { name: "ãƒãƒŠãƒŠ", price: 160 },
            ]
        };

        // --- LOCAL STORAGE FUNCTIONS ---

        function saveData() {
            localStorage.setItem('kushikatsuApp', JSON.stringify({
                registeredNames: state.registeredNames,
                orderHistory: state.orderHistory,
                selectedPerson: state.selectedPerson
            }));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('kushikatsuApp'));
            if (data) {
                state.registeredNames = data.registeredNames || [];
                state.orderHistory = data.orderHistory || [];
                state.selectedPerson = data.selectedPerson || (state.registeredNames.length > 0 ? state.registeredNames[0] : null);
            }
        }

        // --- UI RENDERING FUNCTIONS ---

        const mainContent = document.getElementById('main-content');

        function render() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('onclick').includes(`'${state.currentTab}'`)) {
                    btn.classList.add('active');
                }
            });

            let content = '';
            switch (state.currentTab) {
                case 'names':
                    content = renderNamesTab();
                    break;
                case 'order':
                    content = renderOrderTab();
                    break;
                case 'history':
                    content = renderHistoryTab();
                    break;
                case 'reset':
                    content = renderResetTab();
                    break;
            }
            mainContent.innerHTML = content;
            attachEventListeners();
        }

        function renderNamesTab() {
            const namesList = state.registeredNames.map(name => `
                <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg fade-in">
                    <span class="font-medium">${name}</span>
                    <button class="delete-name-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition" data-name="${name}">å‰Šé™¤</button>
                </div>
            `).join('');

            return `
                <div class="space-y-4">
                    <h2 class="text-xl font-bold">å‚åŠ è€…ç™»éŒ²</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="new-name-input" class="flex-grow border-2 border-gray-300 rounded-lg p-2 focus:border-red-500 focus:ring-red-500" placeholder="åå‰ã‚’å…¥åŠ› (æœ€å¤§20æ–‡å­—)" maxlength="20">
                        <button id="add-name-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">è¿½åŠ </button>
                    </div>
                    <div id="names-list" class="space-y-2 mt-4">
                        ${state.registeredNames.length > 0 ? namesList : '<p class="text-gray-500">ã¾ã èª°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    </div>
                </div>
            `;
        }

        function renderCurrentOrderList() {
            const listEl = document.getElementById('current-order-list');
            const totalEl = document.getElementById('current-order-total');
            const confirmBtn = document.getElementById('confirm-order-btn');

            if (!listEl || !totalEl || !confirmBtn) return;

            const currentOrderItems = state.currentOrders.map(order => `
                <div class="flex justify-between items-center p-2 border-b fade-in">
                    <div>
                        <p class="text-sm sm:text-base">${order.person} - ${order.item}</p>
                        <p class="text-xs sm:text-sm text-gray-500">${order.count}æœ¬ x Â¥${order.price} = Â¥${order.totalPrice.toLocaleString()}</p>
                    </div>
                    <button class="delete-current-order-btn text-red-500 hover:text-red-700 font-bold text-2xl" data-id="${order.id}">Ã—</button>
                </div>
            `).join('');

            listEl.innerHTML = state.currentOrders.length > 0 ? currentOrderItems : '<p class="text-gray-500 text-center pt-4">æ³¨æ–‡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';

            listEl.querySelectorAll('.delete-current-order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteCurrentOrder(e.currentTarget.dataset.id));
            });

            const currentTotal = state.currentOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            totalEl.textContent = `Â¥${currentTotal.toLocaleString()}`;
            confirmBtn.disabled = state.currentOrders.length === 0;
        }

        function renderOrderTab() {
            if (state.registeredNames.length === 0) {
                return `<p class="text-center text-gray-600">å…ˆã«ã€Œå‚åŠ è€…ç™»éŒ²ã€ã‚¿ãƒ–ã§åå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>`;
            }

            const nameOptions = state.registeredNames.map(name => 
                `<option value="${name}" ${name === state.selectedPerson ? 'selected' : ''}>${name}</option>`
            ).join('');
            
            const menuHtml = Object.entries(menu).map(([category, items]) => `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold border-b-2 border-red-200 pb-2 mb-3">${category}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${items.map(item => `
                            <div class="bg-gray-50 p-2 sm:p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-sm sm:text-base">${item.name}</p>
                                    <p class="text-xs sm:text-sm text-gray-500">Â¥${item.price}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="number" class="add-quantity-input w-14 sm:w-16 text-center border rounded-md p-1" placeholder="1" min="1" max="20" data-item-name="${item.name}">
                                    <button class="add-item-btn bg-red-500 text-white px-2 sm:px-3 py-1 rounded-md hover:bg-red-600 transition text-sm" data-item='${JSON.stringify(item)}'>è¿½åŠ </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 custom-scrollbar" style="max-height: 70vh; overflow-y: auto; padding-right: 1rem;">
                        <h2 class="text-xl font-bold mb-4">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                        ${menuHtml}
                    </div>
                    <div class="space-y-4">
                        <h2 class="text-xl font-bold">ç¾åœ¨ã®æ³¨æ–‡</h2>
                        <div class="space-y-2">
                            <label for="order-person-select" class="font-medium">æ³¨æ–‡è€…:</label>
                            <select id="order-person-select" class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-red-500 focus:ring-red-500">
                                ${nameOptions}
                            </select>
                        </div>
                        <div id="current-order-list" class="bg-gray-100 rounded-lg p-3 space-y-2 min-h-[100px] custom-scrollbar" style="max-height: 40vh; overflow-y: auto;"></div>
                        <div class="text-right font-bold text-lg">
                            å°è¨ˆ: <span id="current-order-total">Â¥0</span>
                        </div>
                        <button id="confirm-order-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition" disabled>
                            æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderHistoryTab() {
            if (state.orderHistory.length === 0) {
                return `<p class="text-center text-gray-600">ã¾ã æ³¨æ–‡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            }

            const allOrders = state.orderHistory.flatMap(h => h.orders);
            const totalAmount = allOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const totalItems = allOrders.reduce((sum, order) => sum + order.count, 0);
            const participantCount = state.registeredNames.length;
            const averagePerPerson = participantCount > 0 ? (totalAmount / participantCount) : 0;

            const statsHtml = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 text-center">
                    <div class="bg-blue-100 p-2 sm:p-4 rounded-lg"><p class="text-xs sm:text-sm text-blue-800">ç·æ³¨æ–‡æ•°</p><p class="text-lg sm:text-2xl font-bold text-blue-900">${totalItems.toLocaleString()}æœ¬</p></div>
                    <div class="bg-green-100 p-2 sm:p-4 rounded-lg"><p class="text-xs sm:text-sm text-green-800">åˆè¨ˆé‡‘é¡</p><p class="text-lg sm:text-2xl font-bold text-green-900">Â¥${totalAmount.toLocaleString()}</p></div>
                    <div class="bg-yellow-100 p-2 sm:p-4 rounded-lg"><p class="text-xs sm:text-sm text-yellow-800">å‚åŠ äººæ•°</p><p class="text-lg sm:text-2xl font-bold text-yellow-900">${participantCount}äºº</p></div>
                    <div class="bg-purple-100 p-2 sm:p-4 rounded-lg"><p class="text-xs sm:text-sm text-purple-800">å¹³å‡/äºº</p><p class="text-lg sm:text-2xl font-bold text-purple-900">Â¥${Math.round(averagePerPerson).toLocaleString()}</p></div>
                </div>`;

            const staffOrdersBySessionHtml = [...state.orderHistory].reverse().map(historyEntry => {
                const staffOrderForSession = historyEntry.orders.reduce((acc, order) => {
                    acc[order.item] = (acc[order.item] || 0) + order.count;
                    return acc;
                }, {});
                const sessionOrderHtml = Object.entries(staffOrderForSession).map(([item, count]) => `<div class="flex justify-between p-2 bg-gray-50 rounded-md text-sm"><span>${item}</span><span class="font-semibold">${count}æœ¬</span></div>`).join('');
                return `<div class="bg-gray-100 p-3 sm:p-4 rounded-lg"><h4 class="font-semibold mb-2 text-gray-700 text-sm sm:text-base">æ³¨æ–‡æ—¥æ™‚: ${historyEntry.timestamp} (åˆè¨ˆ: Â¥${historyEntry.totalPrice.toLocaleString()})</h4><div class="space-y-2">${sessionOrderHtml}</div></div>`;
            }).join('');

            const individualHistory = state.registeredNames.map(name => {
                const personOrders = allOrders.filter(o => o.person === name);
                const personTotal = personOrders.reduce((sum, o) => sum + o.totalPrice, 0);
                if (personOrders.length === 0) return '';
                const ordersByItem = personOrders.reduce((acc, order) => {
                    if (!acc[order.item]) acc[order.item] = { count: 0, price: order.price, totalPrice: 0 };
                    acc[order.item].count += order.count;
                    acc[order.item].totalPrice += order.totalPrice;
                    return acc;
                }, {});
                return `<div class="bg-gray-100 p-3 sm:p-4 rounded-lg"><div class="flex justify-between items-baseline"><h4 class="text-base sm:text-lg font-semibold">${name}</h4><span class="font-bold text-red-500">åˆè¨ˆ: Â¥${personTotal.toLocaleString()}</span></div><div class="mt-2 space-y-1 text-xs sm:text-sm">${Object.entries(ordersByItem).map(([item, data]) => `<div class="flex justify-between"><span>${item}</span><span>${data.count}æœ¬ - Â¥${data.totalPrice.toLocaleString()}</span></div>`).join('')}</div></div>`;
            }).join('');

            const staffOrder = allOrders.reduce((acc, order) => { acc[order.item] = (acc[order.item] || 0) + order.count; return acc; }, {});
            const ranking = Object.entries(staffOrder).sort(([, countA], [, countB]) => countB - countA).slice(0, 3);
            const rankingHtml = ranking.map(([item, count], index) => `<div class="flex items-center space-x-2 sm:space-x-4 bg-yellow-50 p-3 rounded-lg"><span class="text-2xl sm:text-3xl">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index]}</span><div><p class="font-bold text-sm sm:text-base">${item}</p><p class="text-xs sm:text-sm text-gray-600">${count}æœ¬</p></div></div>`).join('');

            return `<div class="space-y-8"><div><h2 class="text-xl font-bold mb-4">ã‚µãƒãƒªãƒ¼</h2>${statsHtml}</div><div><h2 class="text-xl font-bold mb-4">ğŸ† ä¸²ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP 3</h2><div class="space-y-2">${ranking.length > 0 ? rankingHtml : '<p class="text-gray-500">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}</div></div><div><h2 class="text-xl font-bold mb-4">ğŸ‘¨â€ğŸ³ åº—å“¡ã•ã‚“ã¸ã®æ³¨æ–‡å†…å®¹ (æ³¨æ–‡å›ã”ã¨)</h2><div class="space-y-4 custom-scrollbar" style="max-height: 400px; overflow-y: auto; padding: 4px;">${staffOrdersBySessionHtml || '<p class="text-gray-500">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}</div></div><div><h2 class="text-xl font-bold mb-4">ğŸ‘¤ å€‹äººåˆ¥æ³¨æ–‡å±¥æ­´ (ç·åˆè¨ˆ)</h2><div class="space-y-4">${individualHistory || '<p class="text-gray-500">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}</div></div></div>`;
        }

        function renderResetTab() {
            return `<div class="text-center space-y-4 p-4 sm:p-8"><h2 class="text-xl font-bold text-red-700">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h2><p class="text-gray-600">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚<br>å…¨ã¦ã®å‚åŠ è€…åã¨æ³¨æ–‡å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p><button id="reset-all-data-btn" class="bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 transition">å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button></div>`;
        }

        // --- EVENT LISTENERS & LOGIC ---

        function attachEventListeners() {
            const addNameBtn = document.getElementById('add-name-btn');
            if (addNameBtn) addNameBtn.addEventListener('click', handleAddName);
            
            const newNameInput = document.getElementById('new-name-input');
            if (newNameInput) newNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleAddName();
                }
            });

            document.querySelectorAll('.delete-name-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteName(e.target.dataset.name)));
            document.querySelectorAll('.add-item-btn').forEach(btn => btn.addEventListener('click', handleAddItem));
            
            const confirmOrderBtn = document.getElementById('confirm-order-btn');
            if (confirmOrderBtn) confirmOrderBtn.addEventListener('click', handleConfirmOrder);
            
            const personSelect = document.getElementById('order-person-select');
            if(personSelect) personSelect.addEventListener('change', handleSelectPerson);

            const resetAllDataBtn = document.getElementById('reset-all-data-btn');
            if (resetAllDataBtn) resetAllDataBtn.addEventListener('click', handleResetAllData);

            if (state.currentTab === 'order' && state.registeredNames.length > 0) {
                renderCurrentOrderList();
            }
        }

        function handleAddName() {
            const input = document.getElementById('new-name-input');
            const name = input.value.trim();
            if (!name) { showAlert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            if (state.registeredNames.includes(name)) { showAlert('ãã®åå‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚'); return; }
            
            input.value = '';
            state.registeredNames.push(name);
            if(state.registeredNames.length === 1) state.selectedPerson = name;
            saveData();
            render();
        }

        function handleDeleteName(name) {
            showModal('åå‰ã®å‰Šé™¤', `ã€Œ${name}ã€ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®äººã®æ³¨æ–‡å±¥æ­´ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`, () => {
                state.registeredNames = state.registeredNames.filter(n => n !== name);
                state.currentOrders = state.currentOrders.filter(o => o.person !== name);
                if (state.selectedPerson === name) state.selectedPerson = state.registeredNames.length > 0 ? state.registeredNames[0] : null;
                state.orderHistory.forEach(h => h.orders = h.orders.filter(o => o.person !== name));
                state.orderHistory = state.orderHistory.filter(h => h.orders.length > 0);
                saveData();
                render();
            });
        }
        
        function handleAddItem(event) {
            const button = event.currentTarget;
            const item = JSON.parse(button.dataset.item);
            const person = state.selectedPerson;

            if (!person) { showAlert('æ³¨æ–‡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

            const input = button.parentElement.querySelector('.add-quantity-input');
            let count = parseInt(input.value, 10);
            if (isNaN(count) || count <= 0) count = 1;
            if (count > 20) count = 20;

            const existingOrderIndex = state.currentOrders.findIndex(o => o.person === person && o.item === item.name);
            if (existingOrderIndex > -1) {
                state.currentOrders[existingOrderIndex].count += count;
                state.currentOrders[existingOrderIndex].totalPrice = state.currentOrders[existingOrderIndex].price * state.currentOrders[existingOrderIndex].count;
            } else {
                state.currentOrders.push({ id: `${person}-${item.name}-${Date.now()}`, person, item: item.name, price: item.price, count, totalPrice: item.price * count });
            }

            input.value = '';
            renderCurrentOrderList();
        }
        
        function handleDeleteCurrentOrder(id) {
            state.currentOrders = state.currentOrders.filter(o => o.id !== id);
            renderCurrentOrderList();
        }

        function handleSelectPerson(event) {
            state.selectedPerson = event.target.value;
            saveData();
        }

        function handleConfirmOrder() {
            if (state.currentOrders.length === 0) { showAlert('æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
            showModal('æ³¨æ–‡ã®ç¢ºå®š', 'ç¾åœ¨ã®æ³¨æ–‡ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ', () => {
                const newHistoryEntry = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                    orders: JSON.parse(JSON.stringify(state.currentOrders)),
                    totalPrice: state.currentOrders.reduce((sum, order) => sum + order.totalPrice, 0)
                };
                state.orderHistory.push(newHistoryEntry);
                state.currentOrders = [];
                saveData();
                showTab('history');
            });
        }

        function handleResetAllData() {
            showModal('å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ', 'æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', () => {
                state.registeredNames = [];
                state.orderHistory = [];
                state.currentOrders = [];
                state.selectedPerson = null;
                saveData();
                render();
            });
        }

        function showTab(tabName) {
            state.currentTab = tabName;
            render();
        }

        let alertTimeout;
        function showAlert(message) {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            alertBox.classList.remove('hidden', 'translate-x-full');
            alertBox.classList.add('translate-x-0');
            clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => {
                alertBox.classList.remove('translate-x-0');
                alertBox.classList.add('translate-x-full');
                setTimeout(() => alertBox.classList.add('hidden'), 300);
            }, 3000);
        }

        function showModal(title, message, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmHandler = () => { onConfirm(); hideModal(); };
            const cancelHandler = () => hideModal();
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', confirmHandler);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.addEventListener('click', cancelHandler);
            modal.classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        window.onload = () => {
            loadData();
            showTab('names');
        };

    </script>
</body>
</html>
